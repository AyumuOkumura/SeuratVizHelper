---
title: "SeuratVizHelper Example: Stacked Violin Plot"
author: "SeuratVizHelper"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8)
```

## Introduction

This document demonstrates how to create a Scanpy-style stacked violin plot using the `StackVln` function from the SeuratVizHelper package.

## Load Required Libraries

# install.packages("devtools")
# devtools::install_github("AyumuOkumura/SeuratVizHelper")

```{r load-libraries}
# Load required packages
library(Seurat)
library(SeuratVizHelper)

# Package required for dataset download
if (!requireNamespace("SeuratData", quietly = TRUE)) {
  if (!requireNamespace("remotes", quietly = TRUE)) {
    install.packages("remotes")
  }
  remotes::install_github('satijalab/seurat-data')
}
library(SeuratData)
```

## Downloading and loading the dataset

Download and load the `pbmc3k` dataset from the SeuratData package.
This dataset is a suitable size for PBMC demonstrations.

```{r load-data}
SeuratData::InstallData("pbmc3k")
pbmc <- SeuratData::LoadData("pbmc3k")

ndim <- 30
pbmc <- pbmc %>%
  NormalizeData() %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA(verbose = FALSE) %>%
  FindNeighbors(dims = 1:ndim, verbose = FALSE) %>%
  FindClusters(resolution = 0.6, verbose = FALSE) %>%
  RunUMAP(dims = 1:ndim, n.neighbors = 30, verbose = FALSE)

DimPlot(pbmc, reduction = "umap", label = TRUE)
```

## Specifying Marker Genes

Create a StackVln plot using the following marker genes:

```{r define-markers}
# List of marker genes
markers <- c('C1QA', 'PSAP', 'CD79A', 'CD79B', 'CST3', 'LYZ')

# Use only genes present in the dataset
available_markers <- markers[markers %in% rownames(pbmc)]

if (length(available_markers) == 0) {
  # If specified markers are not present, use alternative genes
  cat("Specified marker genes are not included in the dataset.\n")
  cat("Using alternative genes.\n")
  # Select from genes present in the dataset
  available_markers <- head(VariableFeatures(pbmc), 6)
}

cat("Marker genes to use:\n")
print(available_markers)
```

## Creating the StackVln plot

Use the `StackVln` function to create a Scanpy-style StackVln plot.

```{r stackvln-plot, fig.width=10, fig.height=8}
# Create StackVln plot
StackVln_p <- StackVln(
  seurat_object = pbmc,
  features = available_markers,
  group.by = "seurat_clusters",
  dendrogram_method = "dims",
  ndim = 30,
  plot_width = 5,
  plot_heights = c(0.3, 3), 
  # Define the height ratio between the "top graph (dendrogram)" and "bottom graph (violin plot)"
  save_dir = file.path("png/ViolinPlot")
)

StackVln_p
```

## Customized Plot

Example with customized colors:

```{r custom-plot, fig.width=12, fig.height=8}
# Plot with custom colors
StackVln_p <- StackVln(
  seurat_object = pbmc,
  features = available_markers,
  group.by = "seurat_clusters",
  dendrogram_method = "dims",
  ndim = 30,
  plot_width = 5,
  plot_heights = c(0.3, 3), 
  # Define the height ratio between the "top graph (dendrogram)" and "bottom graph (violin plot)"
  color_low = 'lightblue',
  color_high = "darkred",
  save_dir = file.path("png/ViolinPlot")
)
StackVln_p
```

## Saving Plots

Example of saving a plot to a file (the `plot_width` parameter is applied when saving the file):

```{r save-plot, eval=FALSE}
# Save the plot to a file
StackVln_p <- StackVln(
  seurat_object = pbmc,
  features = available_markers,
  color_high = "#BD2130",
  plot_width = 12,
  save_dir = "./figures"
)
StackVln_p
```

## Session Information

```{r session-info}
sessionInfo()
```

## Summary

This document demonstrated how to use the SeuratVizHelper package to:

1. Load a PBMC dataset
2. Specify marker genes
3. Create a StackVln plot

For detailed documentation, see the [GitHub repository](https://github.com/AyumuOkumura/SeuratVizHelper).
