# SeuratVizHelper

**SeuratVizHelper** makes single-cell visualization in Seurat easier and more publication-ready. 

## Features

#### ğŸ‡ºğŸ‡¸ English
**Bring Scanpy-style aesthetics to Seurat.**
- ğŸ“Š **Stacked Violin Plots**: Create compact, Scanpy-style stacked violin plots colored by median expression.
- ğŸŒ³ **Automatic Clustering**: Dendrogram-based cluster ordering `BuildClusterTree()`
- ğŸ¨ **Customizable**: Adjustable colors, sizes, and cluster orders
- ğŸ’¾ **Easy Export**: Built-in .png saving.

#### ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
**Seuratã§Scanpyãƒ©ã‚¤ã‚¯ãªå¯è¦–åŒ–ã‚’å®Ÿç¾ã€‚**
- ğŸ“Š **ã‚¹ã‚¿ãƒƒã‚¯ãƒã‚¤ã‚ªãƒªãƒ³ãƒ—ãƒ­ãƒƒãƒˆ**: Scanpyé¢¨ã®ç™ºç¾ä¸­å¤®å€¤ã§è‰²ä»˜ã‘ã•ã‚ŒãŸç©å±¤å‹ãƒã‚¤ã‚ªãƒªãƒ³ãƒ—ãƒ­ãƒƒãƒˆã‚’ç°¡å˜ã«æç”»ã€‚
- ğŸŒ³ **è‡ªå‹•ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°**: BuildClusterTree() ã®ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã«åŸºã¥ãã€ã‚¯ãƒ©ã‚¹ã‚¿é †åºã‚’è‡ªå‹•ã§ç”Ÿç‰©å­¦çš„ã«æ•´åˆ—ã€‚
- ğŸ¨ **é«˜ã„ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§**: è‰²ã€ã‚µã‚¤ã‚ºã€è¡¨ç¤ºé †åºã‚’æŸ”è»Ÿã«èª¿æ•´å¯èƒ½ã€‚
- ğŸ’¾ **ç°¡å˜ä¿å­˜: é«˜è§£åƒåº¦** .png å‡ºåŠ›æ©Ÿèƒ½ã‚’å†…è”µã€‚

#### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Simplified)
**åœ¨ Seurat ä¸­å®ç° Scanpy é£æ ¼çš„å¯è§†åŒ–ã€‚**
- ğŸ“Š **å †å å°æç´å›¾**: ç»˜åˆ¶ Scanpy é£æ ¼çš„å †å å°æç´å›¾ (Stacked Violin Plot)ï¼Œå¹¶æ ¹æ®è¡¨è¾¾ä¸­ä½æ•°å¡«å……é¢œè‰²ã€‚
- ğŸŒ³ **è‡ªåŠ¨èšç±»æ’åº**: åˆ©ç”¨ BuildClusterTree() æ ‘çŠ¶å›¾è‡ªåŠ¨è°ƒæ•´èšç±»é¡ºåºã€‚
- ğŸ¨ **é«˜åº¦å¯å®šåˆ¶**: çµæ´»è°ƒæ•´é¢œè‰²ã€å°ºå¯¸å’ŒåŸºå› åˆ†ç»„ã€‚
- ğŸ’¾ **ä¾¿æ·å¯¼å‡º**: å†…ç½®é«˜åˆ†è¾¨ç‡ .png ä¿å­˜åŠŸèƒ½ã€‚

#### ğŸ‡©ğŸ‡ª Deutsch
**Scanpy-artige Ã„sthetik fÃ¼r Seurat.**
- ğŸ“Š **Gestapelte Violin-Plots**: Erstellen Sie kompakte, Scanpy-artige gestapelte Violin-Plots, gefÃ¤rbt nach **Median-Expression**.
- ğŸŒ³ **Automatische Cluster-Sortierung**: Automatische Anordnung der Cluster basierend auf `BuildClusterTree()` Dendrogrammen.
- ğŸ¨ **Anpassbar**: Farben, GrÃ¶ÃŸen und Cluster-Reihenfolgen sind flexibel einstellbar.
- ğŸ’¾ **Einfacher Export**: Integrierte Funktion zum Speichern hochauflÃ¶sender `.png`-Dateien.

#### ğŸ‡ªğŸ‡¸ EspaÃ±ol
**EstÃ©tica estilo Scanpy en Seurat.**
- ğŸ“Š **GrÃ¡ficos de ViolÃ­n Apilados**: Cree grÃ¡ficos compactos estilo Scanpy, coloreados segÃºn la **expresiÃ³n mediana**.
- ğŸŒ³ **Agrupamiento AutomÃ¡tico**: ReordenaciÃ³n automÃ¡tica de clÃºsteres basada en dendrogramas de `BuildClusterTree()`.
- ğŸ¨ **Personalizable**: Colores, tamaÃ±os y orden de clÃºsteres totalmente ajustables.
- ğŸ’¾ **ExportaciÃ³n FÃ¡cil**: Guardado integrado de imÃ¡genes `.png` de alta resoluciÃ³n.

#### ğŸ‡µğŸ‡¹ PortuguÃªs
**EstÃ©tica estilo Scanpy no Seurat.**
- ğŸ“Š **Violin Plots Empilhados**: Crie plots compactos estilo Scanpy, coloridos pela **expressÃ£o mediana**.
- ğŸŒ³ **ClusterizaÃ§Ã£o AutomÃ¡tica**: ReordenaÃ§Ã£o automÃ¡tica de clusters baseada em dendrogramas do `BuildClusterTree()`.
- ğŸ¨ **PersonalizÃ¡vel**: Cores, tamanhos e ordens de clusters totalmente ajustÃ¡veis.
- ğŸ’¾ **ExportaÃ§Ã£o FÃ¡cil**: Salvamento integrado em `.png` de alta resoluÃ§Ã£o.

#### ğŸ‡®ğŸ‡© Bahasa Indonesia
**Hadirkan estetika gaya Scanpy ke Seurat.**
- ğŸ“Š **Stacked Violin Plots**: Buat plot biola bertumpuk gaya Scanpy yang ringkas, diwarnai berdasarkan **ekspresi median**.
- ğŸŒ³ **Klasterisasi Otomatis**: Pengurutan ulang klaster secara otomatis berdasarkan dendrogram `BuildClusterTree()`.
- ğŸ¨ **Dapat Disesuaikan**: Warna, ukuran, dan urutan klaster yang fleksibel.
- ğŸ’¾ **Ekspor Mudah**: Fitur penyimpanan `.png` resolusi tinggi bawaan.

#### ğŸ‡«ğŸ‡· FranÃ§ais
**Apportez l'esthÃ©tique de Scanpy Ã  Seurat.**
- ğŸ“Š **TracÃ©s en Violon EmpilÃ©s**: CrÃ©ez des "Stacked Violin Plots" compacts de style Scanpy, colorÃ©s par **expression mÃ©diane**.
- ğŸŒ³ **Clustering Automatique**: RÃ©organisation automatique des clusters basÃ©e sur les dendrogrammes de `BuildClusterTree()`.
- ğŸ¨ **Personnalisable**: Couleurs, tailles et ordres des clusters entiÃ¨rement ajustables.
- ğŸ’¾ **Export Facile**: Fonction intÃ©grÃ©e pour sauvegarder en `.png` haute rÃ©solution.

#### ğŸ‡°ğŸ‡· í•œêµ­ì–´
**Seuratì— Scanpy ìŠ¤íƒ€ì¼ì˜ ë¯¸í•™ì„ ë”í•˜ì„¸ìš”.**
- ğŸ“Š **ìŠ¤íƒ ë°”ì´ì˜¬ë¦° í”Œë¡¯**: **ì¤‘ì•™ê°’ ë°œí˜„(median expression)**ìœ¼ë¡œ ì±„ìƒ‰ëœ ì»´íŒ©íŠ¸í•œ Scanpy ìŠ¤íƒ€ì¼ì˜ ìŠ¤íƒ ë°”ì´ì˜¬ë¦° í”Œë¡¯ì„ ìƒì„±í•©ë‹ˆë‹¤.
- ğŸŒ³ **ìë™ í´ëŸ¬ìŠ¤í„°ë§**: `BuildClusterTree()` ë´ë“œë¡œê·¸ë¨ì„ ê¸°ë°˜ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ìˆœì„œë¥¼ ìë™ìœ¼ë¡œ ì¬ì •ë ¬í•©ë‹ˆë‹¤.
- ğŸ¨ **ì‚¬ìš©ì ì •ì˜ ê°€ëŠ¥**: ìƒ‰ìƒ, í¬ê¸° ë° í´ëŸ¬ìŠ¤í„° ìˆœì„œë¥¼ ì™„ë²½í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ğŸ’¾ **ê°„í¸í•œ ë‚´ë³´ë‚´ê¸°**: ê³ í•´ìƒë„ `.png` ì €ì¥ ê¸°ëŠ¥ì´ ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

#### ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹
**Ğ­ÑÑ‚ĞµÑ‚Ğ¸ĞºĞ° Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Scanpy Ğ´Ğ»Ñ Seurat.**
- ğŸ“Š **Ğ¡Ñ‚ĞµĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¡ĞºÑ€Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹**: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Scanpy, Ğ¾ĞºÑ€Ğ°ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ **Ğ¼ĞµĞ´Ğ¸Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞºÑĞ¿Ñ€ĞµÑÑĞ¸Ğ¸**.
- ğŸŒ³ **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞšĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿ĞµÑ€ĞµÑƒĞ¿Ğ¾Ñ€ÑĞ´Ğ¾Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¾Ğ² Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´ĞµĞ½Ğ´Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼ `BuildClusterTree()`.
- ğŸ¨ **ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ°, Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¾Ğ².
- ğŸ’¾ **Ğ›ĞµĞ³ĞºĞ¸Ğ¹ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚**: Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸ `.png`.

---
## AI Usage

This package was made by AI coding tools (Gemini and Github copilot)

## Installation

Install directly from GitHub:

```r
# install.packages("devtools")
devtools::install_github("AyumuOkumura/SeuratVizHelper")
```

## Quick Start

```r
library(Seurat)
library(SeuratVizHelper)

# Load your Seurat object
seurat_obj <- readRDS("seurat_obj.rds")

# Create a stacked violin plot (uses DefaultAssay automatically)
# Save to file
ndim = 20
StackVln(
  seurat_object = seurat_obj,
  features = c("IL7R", "CCR7", "S100A4"),
  group.by = "seurat_clusters",
  dendrogram_method = "dims",
  ndim = ndim, # default 30 dimensions (ndim not specified)
  plot_width = 12,
  plot_heights = c(0.3, 3),
  # Define the height ratio between the "top graph (dendrogram)" and "bottom graph (violin plot)"
  save_dir = "./figures",
         )

genes <- c("CD3D", "CD8A", "CD4", "MS4A1", "CD14")

# With custom tag for organizing marker sets
StackVln(
  seurat_object = seurat_obj,
  features = genes,
  group.by = "seurat_clusters",
  dendrogram_method = "dims",
  ndim = 30,
  plot_width = 5,
  plot_heights = c(0.3, 3), 
  color_high = "#BD2130",
  tag = "immune_markers",  # Adds descriptive tag to filename
  save_dir = file.path("png/ViolinPlot")
)
# Output: seurat_obj_immune_markers_stack_vln.png
```
## Output

### Default Filename Format
When using `save_dir`, the output filename follows this pattern:
- **Without tag**: `{seurat_object}_stack_vln.png`
- **With tag**: `{seurat_object}_{tag}_stack_vln.png`

### Examples

```r
# Default filename
StackVln(seurat_obj, features = c("CD3D", "CD8A"), save_dir = "./plots")
# Output: seurat_obj_stack_vln.png

# With tag - for organizing different marker sets
StackVln(seurat_obj, features = c("CD3D", "CD8A", "CD4"), 
         save_dir = "./plots", tag = "tcells")
# Output: seurat_obj_tcells_stack_vln.png

StackVln(seurat_obj, features = c("MS4A1", "CD79A"), 
         save_dir = "./plots", tag = "bcells")
# Output: seurat_obj_bcells_stack_vln.png
```

**Note**: The `tag` parameter is only used when `save_dir` is specified. If you use `save_path` to provide a full file path, the `tag` parameter will be ignored.

<img src="example/pbmc_stack_vln.png" width="600" alt="PBMC Stacked Violin Plot">

## How StackVln Works: Step-by-Step Computation Details

Understanding the computational workflow behind `StackVln()` helps you make informed decisions about parameters and interpret your results. Here's what happens under the hood:

### Step 1: Data Preparation and Validation

1. **Assay Selection**: If no assay is specified, the function uses `DefaultAssay()` to select the assay
2. **Feature Validation**: The function checks that requested features exist in the selected assay
3. **Group Validation**: Verifies that the `group.by` column exists in the Seurat object's metadata

### Step 2: Cluster Tree Construction

The dendrogram is built using Seurat's `BuildClusterTree()` function. The computation method depends on your `dendrogram_method` parameter:

#### Method A: "dims" (Recommended)
```
1. Extract dimensionality reduction data (e.g., PCA)
   â†’ Uses the specified reduction (default: "pca")
   
2. Calculate cluster centroids in reduced space
   â†’ For each cluster, computes mean coordinates across specified dimensions (default: 1:30)
   
3. Compute pairwise distances between cluster centroids
   â†’ Uses Euclidean distance in the reduced dimensional space
   
4. Perform hierarchical clustering
   â†’ Method: Ward's linkage
   â†’ Creates dendrogram based on cluster similarities
```

**Advantages**: Computationally efficient, robust to noise, captures global transcriptomic relationships

#### Method B: "features"
```
1. Extract expression data for specified features only
   â†’ Uses only the genes you're plotting
   
2. Calculate average expression per cluster
   â†’ For each cluster, computes mean expression of each feature
   
3. Compute correlation/distance between clusters
   â†’ Based solely on the selected marker genes
   
4. Build hierarchical tree
   â†’ Ward's linkage clustering on feature-specific relationships
```

**Advantages**: Shows relationships specific to your markers, useful for focused analysis

#### Method C: "all_variable"
```
1. Identify all variable features in the assay
   â†’ Uses features marked as variable in Seurat object
   
2. Extract expression matrix for all variable features
   â†’ Typically 2000-3000 genes
   
3. Calculate cluster-wise average expression
   â†’ Mean expression across all variable features
   
4. Perform hierarchical clustering
   â†’ Creates comprehensive gene-based dendrogram
```

**Advantages**: Comprehensive gene-based approach, no dimensionality reduction needed

### Step 3: Cluster Ordering

1. **Extract dendrogram structure** from the built cluster tree
2. **Determine optimal leaf order** using hierarchical clustering results
3. **Override with manual order** if `cluster_order` is specified by user

### Step 4: Expression Data Extraction and Scaling

```
For each feature:
1. Extract raw expression values from the specified assay
2. Group cells by cluster (using group.by parameter)
3. Scale expression to 0-1 range within each feature
   â†’ Formula: (value - min) / (max - min)
   â†’ This enables color mapping across different expression scales
```

### Step 5: Violin Plot Generation

```
For each feature Ã— cluster combination:
1. Extract expression distribution for all cells in that cluster
2. Calculate kernel density estimation
   â†’ Creates smooth distribution curve
3. Mirror the density plot to create violin shape
4. Color violin by mean expression (scaled 0-1)
   â†’ Low expression â†’ color_low (default: white)
   â†’ High expression â†’ color_high (default: #BD2130)
```

### Step 6: Layout Assembly

1. **Create dendrogram plot** with height ratio from `plot_heights[1]`
2. **Create stacked violin plots** with height ratio from `plot_heights[2]`
3. **Align plots** vertically using `patchwork` package
4. **Calculate total plot height**: 
   - If not specified: `max(5, length(features) Ã— 0.4 + 2)` inches
   - Ensures adequate space for all features

### Step 7: Export

1. **Create output directory** if it doesn't exist
2. **Save plot** as PNG with specified dimensions
   - Default filename: `{seurat_object_name}_stack_vln.png`
   - Resolution: High-quality for publication

### Key Computational Notes

- **Memory efficiency**: The function processes one feature at a time rather than loading all data at once
- **Scaling strategy**: Per-feature scaling (not global) ensures each gene is visually comparable
- **Clustering algorithm**: Uses Ward's criterion (`ward.D2`) which minimizes within-cluster variance
- **Distance metric**: Euclidean distance in PCA space (for "dims" method) or expression space (other methods)

## Advanced Usage
### Custom Colors

```r
StackVln(
  seurat_object = seurat_obj,
  features = c("IL7R", "CCR7", "S100A4"),
  group.by = "seurat_clusters",
  dendrogram_method = "dims",
  plot_width = 12,
  plot_heights = c(0.3, 3),
  color_low = "lightblue",
ã€€color_high = "darkred",
  save_dir = "./figures",
         )
```

### Handling Long Cluster Names

When your cluster names are long, they may be cut off at the bottom of the plot. Use the `x_label_margin` parameter to adjust the bottom margin and ensure labels are fully visible.

#### Default Behavior
```r
# Default margin (1 inch) - suitable for short cluster names
StackVln(seurat_obj, 
         features = c("CD3D", "CD8A"),
         group.by = "seurat_clusters")
# Works well for names like: "0", "1", "CD4 T", "CD8 T"
```

#### Adjusting Margin for Long Names
```r
# Moderate adjustment for medium-length names
StackVln(seurat_obj, 
         features = c("CD3D", "CD8A"),
         group.by = "cell_type",
         x_label_margin = 1.5)
# Good for: "Naive CD4 T", "Memory B cells"

# Larger adjustment for long names
StackVln(seurat_obj, 
         features = c("CD3D", "CD8A"),
         group.by = "detailed_annotation",
         x_label_margin = 2.5)
# Good for: "CD8+ Effector Memory T cells"

# Maximum adjustment for very long names
StackVln(seurat_obj, 
         features = c("CD3D", "CD8A"),
         x_label_margin = 3)
# Good for: "CD4+ Central Memory T cells (CCR7+)"
```

**Tip**: Start with the default value and incrementally increase by 0.5 inches until all labels are visible.

### Dendrogram Calculation Methods

The `StackVln()` function uses Seurat's `BuildClusterTree()` to calculate hierarchical relationships between clusters. Three methods are available:

#### Method 1: Using Dimensionality Reduction (Recommended)

This method uses PCA or other dimensionality reduction results to calculate cluster relationships. It's computationally efficient and robust to noise.

```r
# Use first 50 PCA dimensions
StackVln(seurat_obj,
         features = c("CD3D", "CD8A", "CD4"),
         dendrogram_method = "dims",
         ndim = 50,
         reduction_for_tree = "pca")

# Use default 30 dimensions (ndim not specified)
StackVln(seurat_obj,
         features = c("CD3D", "CD8A", "CD4"),
         dendrogram_method = "dims")
```

**When to use:**
- Standard workflow for most analyses
- When you have performed PCA or other dimensionality reduction
- For robust clustering relationships across the full transcriptome

**Note:** If `ndim` is not specified, the function defaults to using dimensions 1:30 and displays a message.

#### Method 2: Using Plot Features Only

This method calculates the dendrogram based only on the genes you're plotting.
dendrogram_method = "features"

```r
StackVln(seurat_obj,
         features = c("CD3D", "CD8A", "CD4", "MS4A1", "CD14"),
         dendrogram_method = "features")
```

**When to use:**
- When you want cluster relationships specific to your marker genes
- For focused analysis on a particular gene set
- When your features are carefully selected markers

#### Method 3: Using All Variable Features

This method uses all variable features identified in your Seurat object.

```r
StackVln(seurat_obj,
         features = c("CD3D", "CD8A"),
         dendrogram_method = "all_variable")
```

**When to use:**
- When you want comprehensive gene-based clustering
- As an alternative to dimensionality reduction method
- When you don't have dimensionality reduction results

### Plot Size Customization

Control the dimensions of your plots for optimal visualization and publication quality.

#### Automatic Height Calculation

By default, plot height is automatically calculated based on the number of features:
- Formula: `calc_height = max(5, length(features) * 0.4 + 2)`
- Minimum: 5 inches
- Scales: 0.4 inches per feature + 2 inches base

Examples:
- 3 features â†’ 5 inches (minimum)
- 10 features â†’ 6 inches
- 20 features â†’ 10 inches

#### Adjusting Plot Width

```r
# Wider plot for many clusters
StackVln(seurat_obj,
         features = c("CD3D", "CD8A"),
         plot_width = 15)
```

#### Controlling Dendrogram vs Violin Ratio

The `plot_heights` parameter controls the relative space allocated to dendrogram and violin plots:

```r
# Default: minimal dendrogram, focus on violins
StackVln(seurat_obj, features = genes, plot_heights = c(1, 9))

# Emphasize dendrogram
StackVln(seurat_obj, features = genes, plot_heights = c(2, 8))

# Larger dendrogram for detailed branch structure
StackVln(seurat_obj, features = genes, plot_heights = c(3, 7))

# Minimal dendrogram
StackVln(seurat_obj, features = genes, plot_heights = c(0.5, 9.5))
```

## Troubleshooting

### Cluster Names are Cut Off

**Problem**: Long cluster names are truncated at the bottom of the saved plot.

**Solution**: Increase the `x_label_margin` parameter:
```r
StackVln(seurat_obj, 
         features = genes,
         x_label_margin = 2)  # Increase from default 1
```

Try values between 1 and 3 depending on your label length.

### Plot Height Issues

**Problem**: The plot is too tall or too short.

**Solution**: The height is automatically calculated based on the number of features. For manual control, you can save the plot object and use `ggsave()` with custom dimensions:
```r
p <- StackVln(seurat_obj, features = genes)
ggsave("custom_plot.png", p, width = 10, height = 8, dpi = 300)
```

## Function Arguments

- `seurat_object`: Seurat object containing the assay data
- `features`: Character vector of gene names to plot
- `group.by`: Column name in meta.data for grouping (default: "seurat_clusters")
- `cluster_order`: Optional character vector to specify cluster order manually
- `assay`: Assay to use (default: NULL, automatically uses DefaultAssay())
- `color_low`: Color for low expression (default: "white")
- `color_high`: Color for high expression (default: "#BD2130")
- `plot_heights`: Numeric vector (length=2) for relative heights of dendrogram and violin (default: c(1, 9))
- `plot_width`: Width of the saved plot in inches (default: 10)
- `x_label_margin`: Bottom margin space for x-axis labels in inches (default: 1). Increase this value if cluster names are cut off at the bottom of the plot. Recommended range: 1-3 inches depending on label length.
- `save_path`: Full path to save the file. Overrides save_dir
- `save_dir`: Directory to save the file using a default filename
- `tag`: Optional tag to add to the filename (default: NULL). When specified with save_dir, generates `{seurat_object}_{tag}_stack_vln.png` instead of `{seurat_object}_stack_vln.png`. Ignored when save_path is used.
- `ndim`: Number of dimensions for dendrogram (when method = "dims", default: NULL = 30)
- `dendrogram_method`: Calculation method: "features", "dims" (recommended), or "all_variable" (default: "features")
- `reduction_for_tree`: Reduction to use for "dims" method (default: "pca")

## Citation

If you use SeuratVizHelper in your research, please cite:

```
Okumura, A. (2026). SeuratVizHelper: Enhanced Visualization for Seurat.
R package version 0.0.0.9000.
https://github.com/AyumuOkumura/SeuratVizHelper
```

## License

MIT License

## Issues & Contributions

Please report issues at: https://github.com/AyumuOkumura/SeuratVizHelper/issues
Contributions are welcome via pull requests!

## acknowledgement

- seurat <https://satijalab.org/seurat/>
- scannpy stacked_violin <https://scanpy.readthedocs.io/en/stable/generated/scanpy.pl.stacked_violin.html>

## ğŸŒ Multilingual Overview
#### ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª
**Seuratã§Scanpyãƒ©ã‚¤ã‚¯ãªå¯è¦–åŒ–ã‚’å®Ÿç¾ã€‚**
- ğŸ“Š **ã‚¹ã‚¿ãƒƒã‚¯ãƒã‚¤ã‚ªãƒªãƒ³ãƒ—ãƒ­ãƒƒãƒˆ**: Scanpyé¢¨ã®ç™ºç¾ä¸­å¤®å€¤ã§è‰²ä»˜ã‘ã•ã‚ŒãŸç©å±¤å‹ãƒã‚¤ã‚ªãƒªãƒ³ãƒ—ãƒ­ãƒƒãƒˆã‚’ç°¡å˜ã«æç”»ã€‚
- ğŸŒ³ **è‡ªå‹•ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°**: BuildClusterTree() ã®ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã«åŸºã¥ãã€ã‚¯ãƒ©ã‚¹ã‚¿é †åºã‚’è‡ªå‹•ã§ç”Ÿç‰©å­¦çš„ã«æ•´åˆ—ã€‚
- ğŸ¨ **é«˜ã„ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§**: è‰²ã€ã‚µã‚¤ã‚ºã€è¡¨ç¤ºé †åºã‚’æŸ”è»Ÿã«èª¿æ•´å¯èƒ½ã€‚
- ğŸ’¾ **ç°¡å˜ä¿å­˜: é«˜è§£åƒåº¦** .png å‡ºåŠ›æ©Ÿèƒ½ã‚’å†…è”µã€‚

#### ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Simplified)
**åœ¨ Seurat ä¸­å®ç° Scanpy é£æ ¼çš„å¯è§†åŒ–ã€‚**
- ğŸ“Š **å †å å°æç´å›¾**: ç»˜åˆ¶ Scanpy é£æ ¼çš„å †å å°æç´å›¾ (Stacked Violin Plot)ï¼Œå¹¶æ ¹æ®è¡¨è¾¾ä¸­ä½æ•°å¡«å……é¢œè‰²ã€‚
- ğŸŒ³ **è‡ªåŠ¨èšç±»æ’åº**: åˆ©ç”¨ BuildClusterTree() æ ‘çŠ¶å›¾è‡ªåŠ¨è°ƒæ•´èšç±»é¡ºåºã€‚
- ğŸ¨ **é«˜åº¦å¯å®šåˆ¶**: çµæ´»è°ƒæ•´é¢œè‰²ã€å°ºå¯¸å’ŒåŸºå› åˆ†ç»„ã€‚
- ğŸ’¾ **ä¾¿æ·å¯¼å‡º**: å†…ç½®é«˜åˆ†è¾¨ç‡ .png ä¿å­˜åŠŸèƒ½ã€‚

#### ğŸ‡©ğŸ‡ª Deutsch
**Scanpy-artige Ã„sthetik fÃ¼r Seurat.**
- ğŸ“Š **Gestapelte Violin-Plots**: Erstellen Sie kompakte, Scanpy-artige gestapelte Violin-Plots, gefÃ¤rbt nach **Median-Expression**.
- ğŸŒ³ **Automatische Cluster-Sortierung**: Automatische Anordnung der Cluster basierend auf `BuildClusterTree()` Dendrogrammen.
- ğŸ¨ **Anpassbar**: Farben, GrÃ¶ÃŸen und Cluster-Reihenfolgen sind flexibel einstellbar.
- ğŸ’¾ **Einfacher Export**: Integrierte Funktion zum Speichern hochauflÃ¶sender `.png`-Dateien.

#### ğŸ‡ªğŸ‡¸ EspaÃ±ol
**EstÃ©tica estilo Scanpy en Seurat.**
- ğŸ“Š **GrÃ¡ficos de ViolÃ­n Apilados**: Cree grÃ¡ficos compactos estilo Scanpy, coloreados segÃºn la **expresiÃ³n mediana**.
- ğŸŒ³ **Agrupamiento AutomÃ¡tico**: ReordenaciÃ³n automÃ¡tica de clÃºsteres basada en dendrogramas de `BuildClusterTree()`.
- ğŸ¨ **Personalizable**: Colores, tamaÃ±os y orden de clÃºsteres totalmente ajustables.
- ğŸ’¾ **ExportaciÃ³n FÃ¡cil**: Guardado integrado de imÃ¡genes `.png` de alta resoluciÃ³n.

#### ğŸ‡µğŸ‡¹ PortuguÃªs
**EstÃ©tica estilo Scanpy no Seurat.**
- ğŸ“Š **Violin Plots Empilhados**: Crie plots compactos estilo Scanpy, coloridos pela **expressÃ£o mediana**.
- ğŸŒ³ **ClusterizaÃ§Ã£o AutomÃ¡tica**: ReordenaÃ§Ã£o automÃ¡tica de clusters baseada em dendrogramas do `BuildClusterTree()`.
- ğŸ¨ **PersonalizÃ¡vel**: Cores, tamanhos e ordens de clusters totalmente ajustÃ¡veis.
- ğŸ’¾ **ExportaÃ§Ã£o FÃ¡cil**: Salvamento integrado em `.png` de alta resoluÃ§Ã£o.

#### ğŸ‡®ğŸ‡© Bahasa Indonesia
**Hadirkan estetika gaya Scanpy ke Seurat.**
- ğŸ“Š **Stacked Violin Plots**: Buat plot biola bertumpuk gaya Scanpy yang ringkas, diwarnai berdasarkan **ekspresi median**.
- ğŸŒ³ **Klasterisasi Otomatis**: Pengurutan ulang klaster secara otomatis berdasarkan dendrogram `BuildClusterTree()`.
- ğŸ¨ **Dapat Disesuaikan**: Warna, ukuran, dan urutan klaster yang fleksibel.
- ğŸ’¾ **Ekspor Mudah**: Fitur penyimpanan `.png` resolusi tinggi bawaan.

#### ğŸ‡«ğŸ‡· FranÃ§ais
**Apportez l'esthÃ©tique de Scanpy Ã  Seurat.**
- ğŸ“Š **TracÃ©s en Violon EmpilÃ©s**: CrÃ©ez des "Stacked Violin Plots" compacts de style Scanpy, colorÃ©s par **expression mÃ©diane**.
- ğŸŒ³ **Clustering Automatique**: RÃ©organisation automatique des clusters basÃ©e sur les dendrogrammes de `BuildClusterTree()`.
- ğŸ¨ **Personnalisable**: Couleurs, tailles et ordres des clusters entiÃ¨rement ajustables.
- ğŸ’¾ **Export Facile**: Fonction intÃ©grÃ©e pour sauvegarder en `.png` haute rÃ©solution.

#### ğŸ‡°ğŸ‡· í•œêµ­ì–´
**Seuratì— Scanpy ìŠ¤íƒ€ì¼ì˜ ë¯¸í•™ì„ ë”í•˜ì„¸ìš”.**
- ğŸ“Š **ìŠ¤íƒ ë°”ì´ì˜¬ë¦° í”Œë¡¯**: **ì¤‘ì•™ê°’ ë°œí˜„(median expression)**ìœ¼ë¡œ ì±„ìƒ‰ëœ ì»´íŒ©íŠ¸í•œ Scanpy ìŠ¤íƒ€ì¼ì˜ ìŠ¤íƒ ë°”ì´ì˜¬ë¦° í”Œë¡¯ì„ ìƒì„±í•©ë‹ˆë‹¤.
- ğŸŒ³ **ìë™ í´ëŸ¬ìŠ¤í„°ë§**: `BuildClusterTree()` ë´ë“œë¡œê·¸ë¨ì„ ê¸°ë°˜ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ìˆœì„œë¥¼ ìë™ìœ¼ë¡œ ì¬ì •ë ¬í•©ë‹ˆë‹¤.
- ğŸ¨ **ì‚¬ìš©ì ì •ì˜ ê°€ëŠ¥**: ìƒ‰ìƒ, í¬ê¸° ë° í´ëŸ¬ìŠ¤í„° ìˆœì„œë¥¼ ì™„ë²½í•˜ê²Œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ğŸ’¾ **ê°„í¸í•œ ë‚´ë³´ë‚´ê¸°**: ê³ í•´ìƒë„ `.png` ì €ì¥ ê¸°ëŠ¥ì´ ë‚´ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

#### ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹
**Ğ­ÑÑ‚ĞµÑ‚Ğ¸ĞºĞ° Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Scanpy Ğ´Ğ»Ñ Seurat.**
- ğŸ“Š **Ğ¡Ñ‚ĞµĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¡ĞºÑ€Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹**: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ğ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Scanpy, Ğ¾ĞºÑ€Ğ°ÑˆĞµĞ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ **Ğ¼ĞµĞ´Ğ¸Ğ°Ğ½Ğ½Ğ¾Ğ¹ ÑĞºÑĞ¿Ñ€ĞµÑÑĞ¸Ğ¸**.
- ğŸŒ³ **ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ĞšĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ**: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿ĞµÑ€ĞµÑƒĞ¿Ğ¾Ñ€ÑĞ´Ğ¾Ñ‡Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¾Ğ² Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ´ĞµĞ½Ğ´Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼ `BuildClusterTree()`.
- ğŸ¨ **ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ**: ĞŸĞ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ°, Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº ĞºĞ»Ğ°ÑÑ‚ĞµÑ€Ğ¾Ğ².
- ğŸ’¾ **Ğ›ĞµĞ³ĞºĞ¸Ğ¹ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚**: Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ² Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¼ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ğ¸ `.png`.

---
### ğŸ·ï¸ Keywords / Tags
`R` `Seurat` `scRNA-seq` `Single-cell Visualization` `Stacked Violin Plot` `Scanpy` `BuildClusterTree` `Dendrogram`
---
